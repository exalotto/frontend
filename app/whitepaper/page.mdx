export const meta = {
  title: 'ExaLotto Whitepaper',
  description: 'A decentralized, permissionless, autonomous, and provably fair lottery game.',
};

# ExaLotto Whitepaper

## Abstract

We hereby provide the design specification of **ExaLotto**, a lottery game based on the Ethereum
Virtual Machine (“EVM” in the following).

The game will be managed as a Decentralized Autonomous Organization (“DAO” in the following).

## Motivations

Lottery games have ancient origins tracing back to the Chinese Han Dynasty, between years 205 and
187 BC. The core idea of the game is that every player pays a small amount of money and a randomly
chosen lucky winner gets the money from all contributions.

Unfortunately, classic operation of such games requires a central running authority and subjects
them to several issues:

- **Censorship**: some countries make some or all lotteries illegal.
- **Locality**: lotteries are usually State-managed and subject to local regulations, making them
  impossible to extend across borders and turn global.
- **Obscure or unfair prize allocation**: in a typical lottery game a share of the jackpot is
  attributed to every winning category, but the way these shares are allocated is almost never
  explained and is often unfair.
- **Outright scams**: classic operation provides little to no guarantees about the fairness of the
  drawing process, as well as the actual value of the ticket sales. The drawn numbers may be biased
  to favor specific players, and / or the lottery operator may advertise a jackpot that is
  significantly lower (but still attractive enough) than the ticket sales. It is certainly
  suspicious that many lotteries constantly advertise perfectly round-numbered jackpots like $1M.

Case in point, [Hot Lotto][hot-lotto] has suffered one of the most famous lottery fraud scandals
(not necessarily the worst). Other known frauds include a [Serbian lottery announcing the numbers
before they were drawn][serbian-lottery] and [Chinese lottery operators reportedly stealing jackpot
money][chinese-lottery]. Other frauds that may have occurred might never be uncovered.

We want to overcome all the above problems by implementing a new lottery game based on a
decentralized, trustless, censorship-resistant, and cryptographically verified platform: the EVM.

## Game Description

For scalability reasons the game will run on the [Polygon PoS blockchain][polygon-pos], which is
compatible with Ethereum and can run Solidity programs with little to no modifications.

Players join the game by buying one or more tickets. When buying a ticket a player chooses 6 or more
different numbers between 1 and 90 inclusive.

6 different random numbers between 1 and 90 inclusive are securely drawn by the system once a week,
and all tickets matching two or more of the drawn numbers are awarded a prize. We use the
[ChainLink VRF][chainlink-vrf] to draw the 6 random numbers securely.

Tickets with more than 6 numbers, which we call _higher order tickets_ throughout this paper, are in
every possible regard treated as if the player bought all possible 6-combinations that can be chosen
from those numbers. For example, a ticket with 8 numbers is equivalent to ${8 \choose 6} = 28$
different 6-number tickets, and in general a ticket with $k$ numbers (with $k \ge 6$) is equivalent
to ${k \choose 6}$ different 6-number tickets, with ${k \choose 6}$ being the [binomial
coefficient][binomial-coefficient] _"k choose 6"_ representing the number of ways to choose 6
elements from a set of $k$.

The entire project uses the Dai stablecoin as a currency (see [MakerDAO][makerdao] for more
information): tickets are paid for in Dai and all prizes and revenues are in Dai. This way the
project is not subject to wild price fluctuations that other cryptocurrencies may be subject to.

Given that the target price of a 6-number ticket is \$1.50, the price of a higher-order ticket with
$k$ numbers is calculated multiplying \$1.50 by the binomial coefficient $k \choose 6$. This results
in the following prices:

| Numbers in the ticket | Number of 6-combinations | Price       |
| --------------------- | ------------------------ | ----------- |
| 6                     | 1                        | $ 1.50      |
| 7                     | 7                        | $ 10.50     |
| 8                     | 28                       | $ 42.00     |
| 9                     | 84                       | $ 126.00    |
| 10                    | 210                      | $ 315.00    |
| 11                    | 462                      | $ 693.00    |
| 12                    | 924                      | $ 1,386.00  |
| 13                    | 1716                     | $ 2,574.00  |
| 14                    | 3003                     | $ 4,504.50  |
| 15                    | 5005                     | $ 7,507.50  |
| 16                    | 8008                     | $ 12,012.00 |
| 17                    | 12376                    | $ 18,564.00 |
| 18                    | 18564                    | $ 27,846.00 |
| 19                    | 27132                    | $ 40,698.00 |
| 20                    | 38760                    | $ 58,140.00 |

Five different winning categories are defined:

- tickets matching exactly 2 of the drawn numbers,
- tickets matching exactly 3 of the drawn numbers,
- tickets matching exactly 4 of the drawn numbers,
- tickets matching exactly 5 of the drawn numbers,
- and tickets matching all 6 drawn numbers.

ExaLotto keeps a separate prize for each category. The five prizes are funded by the revenue
generated by the ticket sales as explained in [Prize Allocation](#prize-allocation).

At the end of a round, each winning category may have zero or more winners. If there are zero
winners, as we expect to often be the case for the 6-match category, the prize of that category is
carried over to the next round; otherwise it is made available for withdrawal by the players who own
the winning tickets, and the corresponding prize of the same category in the next round starts over
from zero. An exception to this rule is the prize of the 6-match category (aka the _jackpot_), which
is treated specially as described in [Prize Allocation](#prize-allocation).

An important property of the game is that **6-number tickets only win a prize from their highest
winning category**. For example, a ticket matching 4 numbers will also match 3 numbers in several
ways and 2 numbers in several ways but the player will only be allowed to withdraw a prize from the
4-match category. This is not true for higher-order tickets, for reasons explained in [Prize
Allocation](#prize-allocation), and despite the fact that every higher-order ticket is treated
exactly as the set of all possible 6-combinations in it.

The whole game and its DAO are managed on-chain at all times. The ChainLink VRF invocation is the
only part that runs outside of the EVM, but the ChainLink network is still a decentralized system.
**We don't use any centralized components**.

## DAO Management

As mentioned above, ExaLotto is a decentralized lottery game managed by a DAO. Voting power is
proportional to an [ERC20][erc20] token with trading symbol `EXL`.

The DAO is implemented using standard opensource smartcontracts provided by
[OpenZeppelin][openzeppelin]. Namely we use a [`Governor`][openzeppelin-governor] and a
[`TimelockController`][openzeppelin-timelock-controller] with some added functionality. The `EXL`
token is an [`ERC20Votes`][erc20-votes] token with some added functionality. See the
[Governance](#governance) section for an in-depth description about the implementation.

The `EXL` token is burnable but not mintable. The initial total supply is 1,000,000,000 `EXL` with
18 decimals, or equivalently 1e27 EXL-wei.

The `EXL` token provides its holder with two benefits:

- they can participate in the DAO by making proposals and casting votes,
- they receive a proportional share of the revenue.

The revenue generated by the ticket sales is divided as follows:

- 10% is known as the **partner revenue** and is distributed among `EXL` holders proportionally to
  their `EXL` share,
- 10% is known as the **referral revenue** and is distributed among referrers or `EXL` holders as
  described in [Referral Program](#referral-program),
- and the remaining 80% is used to fund the prizes.

The revenue is checkpointed weekly upon round closure, and the distribution is based on a withdrawal
model. That is common practice in the Ethereum ecosystem due to security and scalability reasons:
distributing tokens by transferring them manually to N recipients would require linear algorithms
that may not scale. Instead, our smartcontracts provide cheap methods to trigger withdrawals and the
website provides the necessary UI to request them.

## Referral Program

ExaLotto allows third parties known as _referrers_ to sell tickets on ExaLotto's behalf. The
incentive is that the referrer earns 10% of the revenue it generates. This referral program is
entirely managed by the lottery smartcontract.

Referrers register themselves on the ExaLotto website, which generates a referrer-specific code and
provides an HTML snippet they can embed in their own website; the snippet creates an ExaLotto widget
in the page where a visitor can buy ExaLotto tickets. The widget uses the referral code to interact
with ExaLotto's smartcontacts, which in turn attribute the referral revenue for the ticket to the
corresponding referrer. At the end of a round the referrer can withdraw the generated revenue.

When no referral code is used and a ticket is sold on the main ExaLotto website, the 10% share
allocated for the referrer is actually distributed among the delegating `EXL` holders as described
in [DAO Management](#dao-management). In other words, when no referral code is used `EXL` holders
receive a total 20% of the ticket value.

## Prize Allocation

As described in the [previous](#dao-management) [sections](#referral-program), 20% of the revenue
from the ticket sales is distributed among partners and referrers; the remaining 80% is used to fund
the game. This 80% is divided in 6 parts: 5 parts are used to fund the prizes of each winning
category, and then an extra one is stashed to fund the jackpot of the next round in case one or more
players match all 6 drawn numbers; that way the jackpot is never zero.

The 6 parts are divided as follows: 18.8% is used to fund the prize for each category and the
remaining 6% is used to fund the stash.

The entire revenue generated by the ticket sales is divided as follows:

TODO: pie chart

At the end of any given round each category may have zero or more winners; if there are zero winners
the prize money of that category is carried over to the next round, while if there are one or more
the category prize must be divided equally among the winners.

Through the rest of this paper we will call $k$-number tickets _"$k$-tickets"_ for brevity.

ExaLotto has two important properties:

1. 6-tickets must be rewarded only from their highest winning category (e.g. a ticket with 4 matches
   will not also be rewarded for matching 3 or 2 numbers in several ways);
2. tickets with more than 6 numbers must be treated exactly as if the player bought all possible
   6-tickets with those numbers, which are $n \choose 6$ for an $n$-ticket.

If a player buys the following 6-ticket:

$$
\{1, 2, 3, 4, 5, 6\}
$$

and the following numbers are drawn:

$$
\{1, 2, 3, 4, 89, 90\}
$$

property #1 dictates that the player will receive a prize from the 4-match category but **not**
$4 \choose 3$ prixes from the 3-match category or $4 \choose 2$ from the 2-match one.

Higher-order tickets however make things more complex. Let’s suppose a player bought the following
8-ticket:

$$
\{1, 2, 3, 4, 5, 6, 7, 8\}
$$

and the same numbers as in the example above were drawn, so there were 4 matches. An 8-ticket
corresponds to many 6-tickets, some of which contain the 4 matching numbers; so the prize from the
4-match category must be weighted accordingly. The 6-tickets containing the 4 matching numbers are:

$$
1, 2, 3, 4, 5, 6\newline
1, 2, 3, 4, 5, 7\newline
1, 2, 3, 4, 5, 8\newline
1, 2, 3, 4, 6, 7\newline
1, 2, 3, 4, 6, 8\newline
1, 2, 3, 4, 7, 8
$$

They are 6 in total and can be counted as the number of ways to choose the remaining 2 numbers that
can be added to the 4 matching numbers to form a 6-ticket. In formulas:

$$
{n - k \choose 6 - k} = {8 - 4 \choose 6 - 4} = {4 \choose 2} = 6
$$

where $n$ is the cardinality of the ticket (8 in this case) and $k$ is its highest winning category.

Next we observe that not all 6-combinations represented by the 8-ticket have all four matching
numbers. The following table provides the exhaustive list of combinations, showing that some of them
match only 3 or 2 of the drawn numbers (highlighted in <span style={{color: 'red'}}>red</span>):

| #   | 6-combination    | # of matches | # of tickets in that rank                                                   |
| --- | ---------------- | ------------ | --------------------------------------------------------------------------- |
| 1   | 1, 2, 3, 4, 5, 6 | 4            |                                                                             |
| 2   | 1, 2, 3, 4, 5, 7 | 4            | ^^ ${4 \choose 4} \cdot {8 - 4 \choose 6 - 4} = 1 \cdot {4 \choose 2} = 6$  |
| 3   | 1, 2, 3, 4, 5, 8 | 4            | ^^                                                                          |
| 4   | 1, 2, 3, 4, 6, 7 | 4            | ^^                                                                          |
| 5   | 1, 2, 3, 4, 6, 8 | 4            | ^^                                                                          |
| 6   | 1, 2, 3, 4, 7, 8 | 4            | ^^                                                                          |
| 7   | 1, 2, 3, 5, 6, 7 | 3            |                                                                             |
| 8   | 1, 2, 3, 5, 6, 8 | 3            | ^^ ${4 \choose 3} \cdot {8 - 4 \choose 6 - 3} = 4 \cdot {4 \choose 3} = 16$ |
| 9   | 1, 2, 3, 5, 7, 8 | 3            | ^^                                                                          |
| 10  | 1, 2, 3, 6, 7, 8 | 3            | ^^                                                                          |
| 11  | 1, 2, 4, 5, 6, 7 | 3            | ^^                                                                          |
| 12  | 1, 2, 4, 5, 6, 8 | 3            | ^^                                                                          |
| 13  | 1, 2, 4, 5, 7, 8 | 3            | ^^                                                                          |
| 14  | 1, 2, 4, 6, 7, 8 | 3            | ^^                                                                          |
| 15  | 1, 3, 4, 5, 6, 7 | 3            | ^^                                                                          |
| 16  | 1, 3, 4, 5, 6, 8 | 3            | ^^                                                                          |
| 17  | 1, 3, 4, 5, 7, 8 | 3            | ^^                                                                          |
| 18  | 1, 3, 4, 6, 7, 8 | 3            | ^^                                                                          |
| 19  | 2, 3, 4, 5, 6, 7 | 3            | ^^                                                                          |
| 20  | 2, 3, 4, 5, 6, 8 | 3            | ^^                                                                          |
| 21  | 2, 3, 4, 5, 7, 8 | 3            | ^^                                                                          |
| 22  | 2, 3, 4, 6, 7, 8 | 3            | ^^                                                                          |
| 23  | 1, 2, 5, 6, 7, 8 | 2            |                                                                             |
| 24  | 1, 3, 5, 6, 7, 8 | 2            | ^^ ${4 \choose 2} \cdot {8 - 4 \choose 6 - 2} = 6 \cdot {4 \choose 4} = 6$  |
| 25  | 1, 4, 5, 6, 7, 8 | 2            | ^^                                                                          |
| 26  | 2, 3, 5, 6, 7, 8 | 2            | ^^                                                                          |
| 27  | 2, 4, 5, 6, 7, 8 | 2            | ^^                                                                          |
| 28  | 3, 4, 5, 6, 7, 8 | 2            | ^^                                                                          |

There are ${8 \choose 6} = 28$ 6-combinations in total, of which:

- 6 match 4 numbers,
- 16 match 3 numbers,
- and 6 match 2 numbers.

The rightmost column of the table shows the formula to calculate the number of 6-combinations in
each winning category, which can be generalized as:

$$
{k \choose i} \cdot {n - k \choose 6 - i}
$$

with:

- $n$ = cardinality of the ticket,
- $k$ = highest winning category,
- $i$ = winning category.

So the generic $n$-ticket matching $k$ of the drawn numbers must be awarded
${k \choose i} \cdot {n - k \choose 6 - i}$ prizes from the $i$-match category.

Note that the binomial coefficient $n \choose k$ is defined to be zero for every $n \lt k$, and
thanks to that our formula works for 6-tickets just as well. For example, for a 6-ticket matching 4
numbers (that is, $n = 6$ and $k = 4$) we have

$$
{k \choose i} \cdot {n - k \choose 6 - i} = {4 \choose i} \cdot {2 \choose 6 - i}
$$

so that the second coefficient becomes 0 for every $i < 4$.

// TODO

Note that we allocate the same fraction of the revenue for all 5 winning categories (i.e.
$80\% \cdot 18.8\%$) because we found this to be the fairest possible allocation. In fact, in order
to award the fairest possible prizes, the share of a given category must be inversely proportional
to the probability of winning and directly proportional to the [expected][expectation] number of
winners. In other words:

- it is fair to allocate a larger share to the winners of a **higher** category because they have a
  **lower** probability of winning; and
- it is fair to allocate a larger share to the winners of a **lower** category because we expect a
  **higher** number of winners.

So we have two conflicting criteria that balance each other out, as we show formally in the
following.

For a given category $k$ we can call the probability of winning in that category $p_k$, and the
expected number of winners $\xi_k$. We can use $n$ to indicate the total number of played
6-combinations in a round. $\xi_k$ is a [binomial variable][binomial-variable] with expected value
$np_k$. Based on the two proportionality criteria above, the share of the revenue allocated to the
prize for category $k$ can be measured as:

$$
S_k = \frac{E(\xi_k)}{p_k} = \frac{np_k}{p_k} = n
$$

This measure does not depend on $p_k$ or any other $k$-dependent parameter, so **all shares must
have the same size**. This is unlike most other lotteries, which allocate seemingly arbitrary or
inadequately explained shares of the revenue to the various categories.

// TODO

[binomial-coefficient]: https://en.wikipedia.org/wiki/Binomial_coefficient
[binomial-variable]: https://en.wikipedia.org/wiki/Binomial_distribution
[chainlink-vrf]: https://chain.link/vrf
[chinese-lottery]: https://www.nikkei.com/article/DGKKASGM08H2T_Z20C15A7EAF000/
[erc20]: https://eips.ethereum.org/EIPS/eip-20
[erc20-votes]: https://docs.openzeppelin.com/contracts/4.x/api/token/erc20#ERC20Votes
[expectation]: https://en.wikipedia.org/wiki/Expected_value
[hot-lotto]: https://en.wikipedia.org/wiki/Hot_Lotto_fraud_scandal
[makerdao]: https://makerdao.com
[openzeppelin]: https://www.openzeppelin.com/
[openzeppelin-governor]: https://docs.openzeppelin.com/contracts/4.x/api/governance#Governor
[openzeppelin-timelock-controller]: https://docs.openzeppelin.com/contracts/4.x/api/governance#TimelockController
[polygon-pos]: https://polygon.technology/polygon-pos
[serbian-lottery]: https://www.independent.co.uk/news/world/europe/serbian-lottery-probe-after-winning-number-called-before-its-drawn-10430922.html

import { Whitepaper } from '@/components/Article';

export default ({ children }) => <Whitepaper meta={meta}>{children}</Whitepaper>;
